# Система управление ботами

## Основной функционал:

1. Создание нового бота в базе данных (передаем данные необходимого бота)
2. Проверка прав администратора для бота (для осуществления постов в канал)
3. Периодический сбор статистики по каналам
4. Привязка канала к боту (в БД) с использованием арбитража активных ботов для равномерного распределения
5. Пост в канал (по заданному markdown)
6. Используемые технологии:
    - FastAPI
    - Celery
    - redis
    - telethon (или аналоги)
    - docker compose
    - nginx
    - postgresql
    - sqlalchemy async
    - basic auth

## Основные технические требования:
Микросервис должен подниматься в Docker контейнерах (docker compose) точкой входа api через nginx

Задания на сбор статистики и проверку необходимо выполнять с помощью celery worker

### Периодические процессы
- (раз в час) Проверка прав администратора для связки бот - канал, для активных связок, в случае потери прав помечаем в базе связку как невалидню и отмечаем причину
- (раз в час) Проверка прав администратора для связки бот - канал, для новых связок, обновляем время последней проверки в базе и отмечаем причину
- (раз в сутки в 00:00) Получение статистики по активным каналам (для активных связок)
количество публикаций за прошеддшие сутки
- совокупное количество просмотров всех публикаций за сутки
## Роуты api
### Добавление бота

```
POST /bots/
{
    "alias": "Псевдоним бота в системе",
    "description": "Описание",
    "token": "telegram_bot_token",
    "name": "bot_name"
}
```
ответ
```
{
    "status": "ok",
    "data": {
        "id": bot_id, # в БД
        "new": true # true если бот раннее не существовал в базе
    }
}
```
ошибка
503
```
{
    "status": "error",
    "message": "Bot can't connect to telegram or smth. else"
}
```
_Примечание_

Необходимо при записи бота в БД проверять его доступность в Telegram вообще

### Удаление бота
```
DELETE /bots/{id}
```
### Изменение бота
```
PATCH /bots/{id}
{
    "alias": "Псевдоним бота в системе",
    "description": "Описание",
    "token": "telegram_bot_token",
    "name": "bot_name"
}
```
### Получение информации по боту из базы
```
GET /bots/{id}
```
### Получение табличных данных по всем ботам
```
GET /bots/
```
### Привязка канала к боту (без указания id бота, бот выбирается арбитражем)

```
POST /channels/
{
    "channel": "https://t.me/....", # ссылка также может вести на закрытый канал, может быть также id канала в телеграме
}
```
- Необходимо получить из телеграма id канала
- Пометить связку бот канал как вновь созданную для дальнейей проверки на права администратора
- В случае невозможности получить инфу по каналу - вернуть исключение и пометить связь бот - канал как невалидную
- Пост осуществляется через celery task соответственно ответ необходимо забирать через роут /tasks/{id}

ответ
```
{
    "channel_id": tg_id,
    "bot_link": "@BOTLink..." // Ссылка на бот, чтобы пользователь мог его активировать в качестве администратора,
    "message": "Канал добавлен, для дальнейшей работы необходимо дать боту права администратора в текущем канале"
}
```
ошибка
503
```
{
    "message": "Задан некорректный идентификатор канала"
}
```
### Отвязать канал (деактивировать привязку)
```
DELETE /channels/{id}
```

### Привязка канала к боту (id бота указывается пользователем)

```
POST /channels/
{
    "channel": "https://t.me/....", # ссылка также может вести на закрытый канал, может быть также id канала в телеграме
    "bot_id": bot_id (БД)
}
```
- Oсуществляется через celery task, результат забирается через роут /tasks/{}
- Необходимо получить из телеграма id канала
- Пометить связку бот канал как вновь созданную для дальнейей проверки на права администратора
- В случае невозможности получить инфу по каналу - вернуть исключение и пометить связь бот - канал как невалидную
- Пост осуществляется через celery task соответственно ответ необходимо забирать через роут /tasks/{id}

ответ
```
{
    "channel_id": tg_id,
    "bot_link": "@BOTLink..." // Ссылка на бот, чтобы пользователь мог его активировать в качестве администратора,
    "message": "Канал добавлен, для дальнейшей работы необходимо дать боту права администратора в текущем канале"
}
```
ошибка
503
```
{
    "message": "Задан некорректный идентификатор канала"
}
```
### Получение инфы по каналу из базы
```
GET /channels/{tg_id}
```
### Получение списка всех каналов
```
GET /channels/
```
### Пост в канал
```
POST /messages
{
  "channel_id": tg_id,
    "message": "markdown text..."
}
```
Пост осуществляется через celery task
### Получение результата по task
```
GET /tasks/{id}
```
ответ
```
{
    "task_id": task_id,
    "task_status": task.status,
    "task_result": task.result
}
```